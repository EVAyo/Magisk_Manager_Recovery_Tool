#!/sbin/sh

set -e

interface="${1}"
updater_fd="${2}"
zipfile="${3}"

temp_path=/tmp/mmr/template
uninstaller_path=${temp_path}/magisk_uninstaller
uninstaller_zip=${temp_path}/Magisk-uninstaller-20200110.zip

install_theme_flag=/tmp/aroma/install_twrp_theme_flag
theme_path=/sdcard/TWRP/theme

ui_print() {
    echo "ui_print $1" > /proc/self/fd/"${updater_fd}"
    echo "ui_print" > /proc/self/fd/"${updater_fd}"
}

uninstall_magisk() {
    mkdir -p $uninstaller_path || :
    test -f $uninstaller_zip
    unzip $uninstaller_zip -d $uninstaller_path

    chmod 0755 ${uninstaller_path}/META-INF/com/google/android/update-binary
    exec ${uninstaller_path}/META-INF/com/google/android/update-binary "${interface}" "${updater_fd}" "${uninstaller_zip}"
}

install_theme() {
    twrp_version=$(getprop ro.twrp.version)
    [ -z "$twrp_version" ] && {
        ui_print "! Failed to get TWRP version! abort..."
        exit 1
    }
    ui_print "- TWRP version: $twrp_version"

    if [[ ${twrp_version::3} = "3.3" ]]; then
        use_zip=$temp_path/ui_sp_v330.zip
    elif [[ ${twrp_version::3} = "3.2" ]]; then
        use_zip=$temp_path/ui_sp_v320.zip
    fi
    [ -z "$use_zip" ] && {
        ui_print "! Not support your TWRP version!"
        ui_print "! Please upgrade your TWRP to 3.2.0+ version!"
        ui_print "! Abort..."
        exit 1
    }

    mkdir -p $theme_path || :
    [ -f ${theme_path}/ui.zip ] && mv -f ${theme_path}/ui.zip ${theme_path}/ui.zip.bak || :
    cp -f $use_zip $theme_path/ui.zip

    . /tmp/mmr/script/common.sh

    test -n "$zip_self"
    test -f "$zip_self"
    [[ $zip_self != ${theme_path}/mmrt/mmrt.zip ]] && {
        ui_print "- Copy tool itself to theme path"
        mkdir -p ${theme_path}/mmrt
        cp -f $zip_self ${theme_path}/mmrt/mmrt.zip
    }

    ui_print "- Done! Theme installed!"
}

if [ -f $install_theme_flag ]; then
    install_theme
    rm -f $install_theme_flag
else
    uninstall_magisk
fi

exit 0
